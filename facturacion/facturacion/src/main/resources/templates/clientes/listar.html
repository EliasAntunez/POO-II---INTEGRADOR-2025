<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layouts/base :: layout(title=~{::title}, content=~{::content})}">

<head>
    <title>Lista de Clientes</title>
</head>

<body>

<th:block th:fragment="content">

    <style>
        tbody tr {
            cursor: pointer;
        }
    
        .fila-seleccionada {
            border-left: 5px solid rgb(82, 12, 82) !important;
            background-color: var(--bs-primary-bg-subtle) !important; 
        }
    </style>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 mb-0">Lista de Clientes</h1>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <form id="accionClienteForm" method="post">
                <input type="hidden" name="id" id="clienteSeleccionadoId" />

                <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                    <table class="table table-striped table-hover align-middle mb-0 border-bottom">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>ID</th>
                                <th>Nombre Completo</th>
                                <th>Razón Social</th>
                                <th>DNI</th>
                                <th>CUIT</th>
                                <th>Email</th>
                                <th>Cond. Fiscal</th>
                                <th class="text-center">Activo</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="cliente : ${clientesPage.content}"
                                th:id="${'clienteRow-' + cliente.id}"
                                th:data-cliente-id="${cliente.id}"
                                onclick="seleccionarClienteDesdeFila(this)">
                                
                                <td th:text="${cliente.id}"></td>
                                <td>
                                    <span th:text="${cliente.nombre}"></span> 
                                    <span th:text="${cliente.apellido}"></span>
                                </td>
                                <td th:text="${cliente.razonSocial}"></td>
                                <td th:text="${cliente.dni}"></td>
                                <td th:text="${cliente.cuit}"></td>
                                <td th:text="${cliente.email}"></td>
                                <td th:text="${cliente.condicionFiscal.descripcion}"></td>
                                <td class="text-center">
                                    <i th:classappend="${cliente.activo} ? 'bi bi-check-circle-fill text-success' : 'bi bi-x-circle-fill text-danger'"
                                       th:title="${cliente.activo ? 'Activo' : 'Inactivo'}"></i>
                                </td>
                            </tr>
                            
                            <tr th:if="${clientes == null OR clientes.empty}">
                                <td colspan="8" class="text-center text-muted p-4">
                                    No se encontraron clientes.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </form>
        </div>
        
        <div class="card-footer bg-white border-top">
            <div>
                <nav aria-label="Paginación clientes" class="d-flex justify-content-center mt-2">
                    <ul class="pagination mb-0">
                        <li class="page-item" th:classappend="${!clientesPage.hasPrevious()} ? 'disabled'">
                            <a class="page-link" th:href="@{/clientes/listar(page=${clientesPage.number-1},size=${clientesPage.size})}" aria-label="Anterior">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(0, clientesPage.totalPages - 1)}" th:classappend="${i == clientesPage.number} ? 'active'">
                            <a class="page-link" th:href="@{/clientes/listar(page=${i},size=${clientesPage.size})}" th:text="${i+1}">1</a>
                        </li>
                        <li class="page-item" th:classappend="${!clientesPage.hasNext()} ? 'disabled'">
                            <a class="page-link" th:href="@{/clientes/listar(page=${clientesPage.number+1},size=${clientesPage.size})}" aria-label="Siguiente">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
        
        <div class="card-footer bg-light py-3">
            <div class="d-flex justify-content-between align-items-center">
                
                <a th:href="@{/clientes/crear}" class="btn btn-success">
                    <i class="bi bi-person-plus me-2"></i>Crear Nuevo Cliente
                </a>
                
                <div class="d-flex gap-2">
                    <button type="button" id="btnModificar" class="btn btn-warning" disabled onclick="modificarCliente()">
                        <i class="bi bi-pencil me-1"></i> Modificar
                    </button>
                    <button type="button" id="btnEliminar" class="btn btn-danger" disabled onclick="eliminarClientePorPath()">
                        <i class="bi bi-trash me-1"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>
        
    </div>

    <script th:inline="javascript">
    /*<![CDATA[*/
    
    let idClienteSeleccionado = null;
    const btnModificar = document.getElementById('btnModificar');
    const btnEliminar = document.getElementById('btnEliminar');
    const inputIdOculto = document.getElementById('clienteSeleccionadoId');

    function seleccionarClienteDesdeFila(filaSeleccionada) {
        const idClicado = filaSeleccionada.dataset.clienteId;

        if (idClicado === idClienteSeleccionado) {
            // Deselección
            filaSeleccionada.classList.remove('fila-seleccionada');
            idClienteSeleccionado = null;
            inputIdOculto.value = '';
            btnModificar.disabled = true;
            btnEliminar.disabled = true;
            
        } else {
            // Selección
            document.querySelectorAll('tbody tr').forEach(row => {
                row.classList.remove('fila-seleccionada');
            });
            filaSeleccionada.classList.add('fila-seleccionada');
            idClienteSeleccionado = idClicado;
            inputIdOculto.value = idClicado;
            btnModificar.disabled = false;
            btnEliminar.disabled = false;
        }
    }
    
    function modificarCliente() {
        if (idClienteSeleccionado) {
            var url = /*[[@{/clientes/modificar}]]*/ '/clientes/modificar';
            window.location.href = url + '?id=' + idClienteSeleccionado;
        } else {
            alert('Por favor, seleccione un cliente para modificar.');
        }
    }
    
    function eliminarClientePorPath() {
        if (idClienteSeleccionado) {
            if (confirm('¿Está seguro que desea eliminar al cliente ID ' + idClienteSeleccionado + '?')) {
                var urlBase = /*[[@{/clientes/eliminar}]]*/ '/clientes/eliminar';
                
                // Creamos un formulario temporal para hacer el POST
                var formEliminar = document.createElement('form');
                formEliminar.method = 'POST';
                formEliminar.action = urlBase + '/' + idClienteSeleccionado; 
                document.body.appendChild(formEliminar);
                formEliminar.submit();
            }
        } else {
            alert('Por favor, seleccione un cliente para eliminar.');
        }
    }
    
    /*]]>*/
    </script>
</th:block>

</body>
</html>