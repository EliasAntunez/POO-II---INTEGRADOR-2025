<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{layouts/base :: layout(title=~{::title}, content=~{::content})}">
<head>
    <title>Detalle de Factura</title>
</head>
<body>
    <th:block th:fragment="content">
        <style>
            .info-factura dt {
                font-weight: 600;
                color: #495057;
            }
            .info-factura dd {
                margin-bottom: 0.5rem;
            }
        </style>

        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a th:href="@{/facturas/listar}">Facturas</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page" 
                    th:text="${'Factura ' + factura.numeroFactura}">
                </li>
            </ol>
        </nav>

        <!-- Mensajes -->
        <div th:if="${exito}" class="alert alert-success alert-dismissible fade show">
            <i class="bi bi-check-circle-fill me-2"></i>
            <span th:text="${exito}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Encabezado -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2 mb-0">
                <i class="bi bi-receipt"></i>
                Factura <span th:text="${factura.numeroFactura}"></span>
            </h1>
            
            <span th:if="${factura.estado.name() == 'EMITIDA'}" class="badge bg-info fs-5">
                <i class="bi bi-file-earmark-text"></i> Emitida
            </span>
            <span th:if="${factura.estado.name() == 'PENDIENTE_PAGO'}" class="badge bg-warning fs-5">
                <i class="bi bi-hourglass-split"></i> Pendiente de Pago
            </span>
            <span th:if="${factura.estado.name() == 'PAGADA'}" class="badge bg-success fs-5">
                <i class="bi bi-check-circle-fill"></i> Pagada
            </span>
            <span th:if="${factura.estado.name() == 'ANULADA'}" class="badge bg-danger fs-5">
                <i class="bi bi-x-circle-fill"></i> Anulada
            </span>
        </div>

        <div class="row">
            <!-- Información del Cliente -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-person-circle"></i> Cliente
                        </h5>
                    </div>
                    <div class="card-body">
                        <dl class="row info-factura mb-0">
                            <dt class="col-sm-4">Nombre:</dt>
                            <dd class="col-sm-8" 
                                th:text="${factura.cliente.nombre + ' ' + factura.cliente.apellido}">
                            </dd>
                            
                            <dt class="col-sm-4">Razón Social:</dt>
                            <dd class="col-sm-8" th:text="${factura.cliente.razonSocial}"></dd>
                            
                            <dt class="col-sm-4">CUIT:</dt>
                            <dd class="col-sm-8" th:text="${factura.cliente.cuit}"></dd>
                            
                            <dt class="col-sm-4">Email:</dt>
                            <dd class="col-sm-8" th:text="${factura.cliente.email}"></dd>
                            
                            <dt class="col-sm-4">Teléfono:</dt>
                            <dd class="col-sm-8" th:text="${factura.cliente.telefono}"></dd>
                        </dl>
                    </div>
                </div>
            </div>

            <!-- Información de la Factura -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-file-earmark-text"></i> Datos de la Factura
                        </h5>
                    </div>
                    <div class="card-body">
                        <dl class="row info-factura mb-0">
                            <dt class="col-sm-5">Fecha Emisión:</dt>
                            <dd class="col-sm-7" 
                                th:text="${#temporals.format(factura.fechaEmision, 'dd/MM/yyyy')}">
                            </dd>
                            
                            <dt class="col-sm-5" th:if="${factura.fechaPago != null}">Fecha Pago:</dt>
                            <dd class="col-sm-7" th:if="${factura.fechaPago != null}"
                                th:text="${#temporals.format(factura.fechaPago, 'dd/MM/yyyy')}">
                            </dd>
                            
                            <dt class="col-sm-5" th:if="${factura.usuarioPago != null}">Usuario Pago:</dt>
                            <dd class="col-sm-7" th:if="${factura.usuarioPago != null}"
                                th:text="${factura.usuarioPago}">
                            </dd>
                            
                            <dt class="col-sm-5">Estado:</dt>
                            <dd class="col-sm-7">
                                <span th:text="${factura.estado.descripcion}" 
                                      class="badge"
                                      th:classappend="${factura.estado.name() == 'PAGADA'} ? 'bg-success' : 
                                                      (${factura.estado.name() == 'ANULADA'} ? 'bg-danger' : 'bg-warning')">
                                </span>
                            </dd>
                            
                            <!-- HU-12: Información de Pagos -->
                            <dt class="col-sm-5">Total Pagado:</dt>
                            <dd class="col-sm-7">
                                <strong class="text-success" 
                                        th:text="${'$ ' + #numbers.formatDecimal(factura.calcularTotalPagado(), 1, 'POINT', 2, 'COMMA')}">
                                </strong>
                            </dd>
                            
                            <dt class="col-sm-5" th:if="${factura.tieneSaldoPendiente()}">Saldo Pendiente:</dt>
                            <dd class="col-sm-7" th:if="${factura.tieneSaldoPendiente()}">
                                <strong class="text-danger" 
                                        th:text="${'$ ' + #numbers.formatDecimal(factura.calcularSaldoPendiente(), 1, 'POINT', 2, 'COMMA')}">
                                </strong>
                            </dd>
                            
                            <!-- HU-09: Nota de Crédito -->
                            <dt class="col-sm-5" th:if="${factura.notaCredito != null}">Nota de Crédito:</dt>
                            <dd class="col-sm-7" th:if="${factura.notaCredito != null}">
                                <span class="badge bg-danger" th:text="${factura.notaCredito.numero}"></span>
                            </dd>
                            
                            <dt class="col-sm-5" th:if="${factura.observaciones != null}">Observaciones:</dt>
                            <dd class="col-sm-7" th:if="${factura.observaciones != null}"
                                th:text="${factura.observaciones}">
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detalles de la Factura -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul"></i> Detalle de Servicios
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Descripción</th>
                                <th class="text-center">Cantidad</th>
                                <th class="text-end">Precio Unit.</th>
                                <th class="text-center">Alícuota</th>
                                <th class="text-end">Subtotal</th>
                                <th class="text-end">IVA</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="detalle : ${factura.detalles}">
                                <td th:text="${detalle.descripcion}"></td>
                                <td class="text-center" th:text="${detalle.cantidad}"></td>
                                <td class="text-end" 
                                    th:text="${'$ ' + #numbers.formatDecimal(detalle.precioUnitario, 1, 'POINT', 2, 'COMMA')}">
                                </td>
                                <td class="text-center" 
                                    th:text="${#numbers.formatDecimal(detalle.porcentajeIva, 1, 2) + '%'}">
                                </td>
                                <td class="text-end" 
                                    th:text="${'$ ' + #numbers.formatDecimal(detalle.subtotal, 1, 'POINT', 2, 'COMMA')}">
                                </td>
                                <td class="text-end" 
                                    th:text="${'$ ' + #numbers.formatDecimal(detalle.totalIva, 1, 'POINT', 2, 'COMMA')}">
                                </td>
                                <td class="text-end">
                                    <strong th:text="${'$ ' + #numbers.formatDecimal(detalle.total, 1, 'POINT', 2, 'COMMA')}">
                                    </strong>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th colspan="4" class="text-end">Subtotal:</th>
                                <th class="text-end" 
                                    th:text="${'$ ' + #numbers.formatDecimal(factura.subtotal, 1, 'POINT', 2, 'COMMA')}">
                                </th>
                                <th colspan="2"></th>
                            </tr>
                            <tr>
                                <th colspan="4" class="text-end">Total IVA:</th>
                                <th colspan="2" class="text-end" 
                                    th:text="${'$ ' + #numbers.formatDecimal(factura.totalIva, 1, 'POINT', 2, 'COMMA')}">
                                </th>
                                <th></th>
                            </tr>
                            <tr class="table-success">
                                <th colspan="4" class="text-end">TOTAL:</th>
                                <th colspan="3" class="text-end fs-4" 
                                    th:text="${'$ ' + #numbers.formatDecimal(factura.montoTotal, 1, 'POINT', 2, 'COMMA')}">
                                </th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- HU-12: Historial de Pagos -->
        <div th:if="${!factura.pagos.empty}" class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> Historial de Pagos
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Fecha</th>
                                <th>Usuario</th>
                                <th class="text-end">Monto</th>
                                <th>Tipo</th>
                                <th>Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="pago : ${factura.pagos}">
                                <td th:text="${#temporals.format(pago.fechaPago, 'dd/MM/yyyy HH:mm')}"></td>
                                <td th:text="${pago.usuario}"></td>
                                <td class="text-end">
                                    <strong class="text-success" 
                                            th:text="${'$ ' + #numbers.formatDecimal(pago.monto, 1, 'POINT', 2, 'COMMA')}">
                                    </strong>
                                </td>
                                <td>
                                    <span th:if="${pago.esPagoTotal}" class="badge bg-success">Total</span>
                                    <span th:unless="${pago.esPagoTotal}" class="badge bg-info">Parcial</span>
                                </td>
                                <td th:text="${pago.observaciones ?: '-'}"></td>
                            </tr>
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th colspan="2" class="text-end">Total Pagado:</th>
                                <th class="text-end">
                                    <span class="text-success fs-5" 
                                          th:text="${'$ ' + #numbers.formatDecimal(factura.calcularTotalPagado(), 1, 'POINT', 2, 'COMMA')}">
                                    </span>
                                </th>
                                <th colspan="2"></th>
                            </tr>
                            <tr th:if="${factura.tieneSaldoPendiente()}">
                                <th colspan="2" class="text-end">Saldo Pendiente:</th>
                                <th class="text-end">
                                    <span class="text-danger fs-5" 
                                          th:text="${'$ ' + #numbers.formatDecimal(factura.calcularSaldoPendiente(), 1, 'POINT', 2, 'COMMA')}">
                                    </span>
                                </th>
                                <th colspan="2"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- HU-09: Nota de Crédito -->
        <div th:if="${factura.notaCredito != null}" class="card mb-4 border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="bi bi-file-earmark-x"></i> Nota de Crédito
                </h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-3">Número NC:</dt>
                    <dd class="col-sm-9">
                        <strong th:text="${factura.notaCredito.numero}"></strong>
                    </dd>
                    
                    <dt class="col-sm-3">Fecha Emisión:</dt>
                    <dd class="col-sm-9" 
                        th:text="${#temporals.format(factura.notaCredito.fechaEmision, 'dd/MM/yyyy')}">
                    </dd>
                    
                    <dt class="col-sm-3">Monto:</dt>
                    <dd class="col-sm-9">
                        <strong th:text="${'$ ' + #numbers.formatDecimal(factura.notaCredito.monto, 1, 'POINT', 2, 'COMMA')}">
                        </strong>
                    </dd>
                    
                    <dt class="col-sm-3">Motivo:</dt>
                    <dd class="col-sm-9" th:text="${factura.notaCredito.motivo}"></dd>
                    
                    <dt class="col-sm-3">Responsable:</dt>
                    <dd class="col-sm-9" th:text="${factura.notaCredito.usuarioResponsable}"></dd>
                    
                    <dt class="col-sm-3" th:if="${factura.notaCredito.observaciones != null}">Observaciones:</dt>
                    <dd class="col-sm-9" th:if="${factura.notaCredito.observaciones != null}"
                        th:text="${factura.notaCredito.observaciones}">
                    </dd>
                </dl>
            </div>
        </div>

        <!-- Acciones -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <a th:href="@{/facturas/listar}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Volver al Listado
                    </a>
                    
                    <div>
                        <!-- HU-11: Botón Registrar Pago Total -->
                        <a th:if="${factura.puedePagarse() and factura.tieneSaldoPendiente()}" 
                           th:href="@{/facturas/{id}/confirmar-pago(id=${factura.id})}" 
                           class="btn btn-success btn-lg">
                            <i class="bi bi-cash-coin"></i> Pagar Total
                        </a>
                        
                        <!-- HU-12: Botón Pago Parcial -->
                        <a th:if="${factura.puedePagarse() and factura.tieneSaldoPendiente()}" 
                           th:href="@{/facturas/{id}/pago-parcial(id=${factura.id})}" 
                           class="btn btn-info btn-lg ms-2">
                            <i class="bi bi-cash-stack"></i> Pago Parcial
                        </a>
                        
                        <!-- HU-09: Botón Anular -->
                        <a th:if="${factura.estado.name() == 'EMITIDA'}" 
                           th:href="@{/facturas/{id}/anular(id=${factura.id})}" 
                           class="btn btn-danger ms-2">
                            <i class="bi bi-x-circle"></i> Anular con NC
                        </a>
                    </div>
                </div>
            </div>
        </div>

    </th:block>
</body>
</html>