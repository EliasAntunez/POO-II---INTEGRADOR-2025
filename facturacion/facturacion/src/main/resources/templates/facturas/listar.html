<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layouts/base :: layout(title=~{::title}, content=~{::content})}">
<head>
    <title>Gestión de Facturas</title>
</head>
<body>
<th:block th:fragment="content">

    <style>
        .btn-purple {
            background-color: #8a2be2; /* Violeta */
            border-color: #8a2be2;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-purple:hover {
            background-color: #7b27cc;
            color: white;
        }
        
        .btn-blue-action {
            font-weight: 600;
        }

        .icon-box {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 1.2rem;
            margin-right: 15px;
        }
        
        .icon-box-blue { background-color: #e7f1ff; color: #0d6efd; }
        .icon-box-green { background-color: #d1e7dd; color: #198754; }

        .search-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            margin-bottom: 20px;
        }
        
        .table-container {
            background-color: #fff;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        /* SCROLL FIX */
        .table-responsive {
            overflow-x: auto;
            overflow-y: visible;
            max-height: none !important;
            height: auto !important;
        }

        /* Estilos de texto y badges */
        .client-name { font-weight: bold; color: #000; display: block; }
        .client-cuit { font-size: 0.85rem; color: #6c757d; }
        .total-amount { font-weight: 700; font-size: 1rem; }
        
        .badge-anulada { background-color: #dc3545; color: white; font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; text-transform: uppercase; font-weight: 600; }
        .badge-pendiente { background-color:#0d6efd ; color: white; font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; text-transform: uppercase; font-weight: 600; }
        .badge-pagada { background-color: #4f9474; color: white; font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; text-transform: uppercase; font-weight: 600; }
        .badge-parcial { background-color: #c09208; color: white; font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; text-transform: uppercase; font-weight: 600; }
    </style>

    <div class="d-flex align-items-center mb-3">
        <i class="bi bi-receipt-cutoff fs-3 me-2"></i>
        <h2 class="mb-0 fw-bold">Gestión de Facturas</h2>
    </div>

    <div class="search-container">
        <form th:action="@{/facturas/listar}" method="get">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label text-muted small"><i class="bi bi-funnel"></i> Filtrar por Estado</label>
                    <select name="estado" class="form-select" onchange="this.form.submit()">
                        <option value="">Todos los estados</option>
                        <option th:each="e : ${listaEstados}" 
                                th:value="${e.name()}" 
                                th:text="${e.descripcion}" 
                                th:selected="${e.name() == (estadoSeleccionado != null ? estadoSeleccionado.name() : '')}">
                        </option>
                    </select>
                </div>

                <div class="col-md-9">
                    <label class="form-label text-muted small"><i class="bi bi-search"></i> Buscar</label>
                    <div class="input-group">
                        <input type="text" name="busqueda" class="form-control" 
                               placeholder="Nombre, DNI, CUIT, Email..." 
                               th:value="${busqueda}"> 
                        <button type="submit" class="btn btn-primary px-4">
                            <i class="bi bi-search me-2"></i> Buscar
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div th:if="${exito}" class="alert alert-success alert-dismissible fade show">
        <i class="bi bi-check-circle-fill me-2"></i> <span th:text="${exito}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${info}" class="alert alert-info alert-dismissible fade show">
        <i class="bi bi-info-circle-fill me-2"></i> <span th:text="${info}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
        <i class="bi bi-exclamation-triangle-fill me-2"></i> <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="table-container">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light border-bottom">
                    <tr>
                        <th class="text-center" style="width: 5%;">N° Factura</th>
                        <th style="width: 20%;">Fecha Emisión</th>
                        <th style="width: 35%;">Cliente</th>
                        <th class="text-end" style="width: 15%;">Total</th>
                        <th class="text-center" style="width: 10%;">Estado</th>
                        <th class="text-end" style="width: 15%;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="factura : ${facturasPage.content}">
                        <td class="text-center text-muted small" th:text="${factura.id}"></td>
                        
                        <td th:text="${#temporals.format(factura.fechaEmision, 'dd/MM/yyyy HH:mm')}"></td>
                        
                        <td>
                            <div class="fw-bold text-dark" th:text="${factura.cliente.razonSocial}"></div>
                            <small class="text-muted" th:text="${factura.cliente.cuit}"></small>
                        </td>
                        
                        <td class="text-end total-amount">
                            <span th:text="${'$ ' + #numbers.formatDecimal(factura.total, 1, 'POINT', 2, 'COMMA')}"></span>
                        </td>

                        
                        
                        <td class="text-center">
                            <span th:if="${factura.estado.name() == 'ANULADA'}" class="badge-anulada">ANULADA</span>
                            <span th:if="${factura.estado.name() == 'PENDIENTE_PAGO'}" class="badge-pendiente">PENDIENTE DE PAGO</span>
                            <span th:if="${factura.estado.name() == 'PAGADA'}" class="badge-pagada">PAGADA</span>
                            <span th:if="${factura.estado.name() == 'PARCIALMENTE_PAGADA'}" class="badge-parcial">PARCIALMENTE PAGADA</span>
                        </td>

                        <td class="text-end">
                            <a th:href="@{/facturas/ver/{id}(id=${factura.id})}" 
                               class="btn btn-sm btn-outline-primary" title="Ver Detalle">
                                <i class="bi bi-eye"></i>
                            </a>
                            
                            <span th:if="${!factura.anulada and factura.montoPagado == 0}">
                                <form th:action="@{/facturas/anular/{id}(id=${factura.id})}" 
                                      method="post" class="d-inline-block ms-1"
                                      onsubmit="return confirm('¿Confirma la anulación de esta factura?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Anular">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </form>
                            </span>

                            <a th:if="${factura.montoPagado > 0}" 
                               th:href="@{/facturas/ver-pagos/{id}(id=${factura.id})}" 
                               class="btn btn-sm btn-outline-success ms-1" title="Ver Comprobantes de Pago">
                                <i class="bi bi-receipt"></i>
                            </a>
                            
                            <a th:if="${factura.anulada}" 
                               th:href="@{/facturas/ver-nota-credito/factura/{id}(id=${factura.id})}"
                               class="btn btn-sm btn-outline-warning ms-1" title="Ver Nota de Crédito">
                                <i class="bi bi-file-earmark-break"></i>
                            </a>
                        </td>

                    </tr>
                    <tr th:if="${facturasPage.empty}">
                        <td colspan="6" class="text-center py-5 text-muted">
                            No se encontraron facturas.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="card-footer bg-white border-top py-3" th:if="${facturasPage.totalPages > 1}">
            <nav aria-label="Paginación facturas" class="d-flex justify-content-center mt-2">
                <ul class="pagination mb-0">
                    
                    <li class="page-item" th:classappend="${!facturasPage.hasPrevious()} ? 'disabled'">
                        <a class="page-link" 
                           th:href="@{/facturas/listar(page=${facturasPage.number - 1}, size=${facturasPage.size}, estado=${estadoSeleccionado}, busqueda=${busqueda}, fechaDesde=${fechaDesdeSeleccionada}, fechaHasta=${fechaHastaSeleccionada})}" 
                           aria-label="Anterior">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    
                    <li class="page-item" 
                        th:each="i : ${#numbers.sequence(0, facturasPage.totalPages - 1)}" 
                        th:classappend="${i == facturasPage.number} ? 'active'">
                        <a class="page-link" 
                           th:href="@{/facturas/listar(page=${i}, size=${facturasPage.size}, estado=${estadoSeleccionado}, busqueda=${busqueda}, fechaDesde=${fechaDesdeSeleccionada}, fechaHasta=${fechaHastaSeleccionada})}" 
                           th:text="${i + 1}">
                        </a>
                    </li>
                    
                    <li class="page-item" th:classappend="${!facturasPage.hasNext()} ? 'disabled'">
                        <a class="page-link" 
                           th:href="@{/facturas/listar(page=${facturasPage.number + 1}, size=${facturasPage.size}, estado=${estadoSeleccionado}, busqueda=${busqueda}, fechaDesde=${fechaDesdeSeleccionada}, fechaHasta=${fechaHastaSeleccionada})}" 
                           aria-label="Siguiente">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                    
                </ul>
            </nav>
        </div>
    </div>

    <div class="row g-4 mb-5">
        
        <div class="col-md-6">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body p-4">
                    <div class="d-flex align-items-start mb-3">
                        <div class="icon-box icon-box-blue">
                            <i class="bi bi-person-badge"></i>
                        </div>
                        <div>
                            <h5 class="card-title fw-bold mb-1">Facturación Individual</h5>
                            <small class="text-muted">Ciclo manual para un cliente</small>
                        </div>
                    </div>
                    
                    <p class="text-muted small mb-4">
                        Utilice esta opción para generar la factura mensual de un cliente específico fuera del ciclo automático. 
                        El sistema buscará los <strong>servicios activos</strong> contratados.
                    </p>
                    
                    <hr class="text-muted opacity-25">

                    <form th:action="@{/facturas/generar-individual}" method="post">
                        <label class="form-label fw-bold small">Seleccionar Cliente</label>
                        <select name="clienteId" id="clienteId" class="form-select mb-3" required onchange="cargarServiciosCliente()">
                            <option value="" disabled selected>-- Buscar cliente --</option>
                            <option th:each="c : ${listaClientes}" 
                                    th:value="${c.id}" 
                                    th:text="${c.razonSocial + ' - ' + c.cuit}">
                            </option>
                        </select>

                        <!-- Selección de Servicios -->
                        <div id="serviciosContainer" class="mb-3" style="display: none;">
                            <label class="form-label fw-bold small">Servicios a Facturar</label>
                            <div class="card p-2 bg-light">
                                <div class="form-check mb-2 border-bottom pb-2">
                                    <input class="form-check-input" type="checkbox" id="selectAllServicios" checked onchange="toggleAllServicios()">
                                    <label class="form-check-label fw-bold small" for="selectAllServicios">Seleccionar Todos</label>
                                </div>
                                <div id="listaServicios" style="max-height: 150px; overflow-y: auto;">
                                    <!-- Checkboxes inyectados por JS -->
                                    <div class="text-center text-muted"><small>Cargando servicios...</small></div>
                                </div>
                                <div id="mensajeSinServicios" class="text-danger small mt-2" style="display:none;">
                                    <i class="bi bi-exclamation-circle"></i> El cliente no tiene servicios activos.
                                </div>
                            </div>
                            <div class="form-text" style="font-size: 0.7rem;">Si no selecciona ninguno, no se generará factura.</div>
                        </div>
                        
                        <!-- Tipo de Facturación -->
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Tipo de Facturación</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoFacturacion" 
                                       id="tipoMensualInd" value="mensual" checked 
                                       onchange="toggleRangoFechasIndividual()">
                                <label class="form-check-label small" for="tipoMensualInd">
                                    <strong>Por Mes</strong> (Seleccionar mes completo)
                                </label>
                                
                                <!-- Selector de Mes (visible solo si es mensual) -->
                                <div id="selectorMesContainer" class="mt-2 ms-3" style="max-width: 200px;">
                                    <label for="mesFacturacion" class="form-label small text-muted" style="font-size: 0.75rem;">Mes a facturar:</label>
                                    <input type="month" id="mesFacturacion" name="mesFacturacion" class="form-control form-control-sm">
                                    <div class="form-text" style="font-size: 0.7rem;">Si se deja vacío, se usará el mes anterior.</div>
                                </div>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="radio" name="tipoFacturacion" 
                                       id="tipoRangoInd" value="rango" 
                                       onchange="toggleRangoFechasIndividual()">
                                <label class="form-check-label small" for="tipoRangoInd">
                                    <strong>Rango personalizado</strong> (especificar fechas exactas)
                                </label>
                            </div>
                        </div>
                        
                        <!-- Campos de Rango (inicialmente ocultos) -->
                        <div id="rangoFechasIndividual" style="display: none;" class="mb-3">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label for="fechaInicioInd" class="form-label fw-bold small">
                                        <i class="bi bi-calendar-range me-1"></i> Desde
                                    </label>
                                    <input type="date" name="fechaInicio" id="fechaInicioInd" class="form-control form-control-sm">
                                </div>
                                <div class="col-6">
                                    <label for="fechaFinInd" class="form-label fw-bold small">
                                        <i class="bi bi-calendar-range me-1"></i> Hasta
                                    </label>
                                    <input type="date" name="fechaFin" id="fechaFinInd" class="form-control form-control-sm">
                                </div>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-blue-action">
                                <i class="bi bi-file-earmark-plus me-2"></i> Generar Factura Individual
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body p-4">
                    <div class="d-flex align-items-start mb-3">
                        <div class="icon-box icon-box-green">
                            <i class="bi bi-collection-play"></i>
                        </div>
                        <div>
                            <h5 class="card-title fw-bold mb-1">Facturación Masiva</h5>
                            <small class="text-muted">Ciclo mensual automático</small>
                        </div>
                    </div>
                    
                    <p class="text-muted small mb-3">
                        Este proceso recorrerá <strong>TODOS</strong> los clientes del sistema que tengan servicios activos y generará sus respectivas facturas.
                    </p>

                    <div class="alert alert-warning border-0 bg-warning bg-opacity-10 py-2 px-3 mb-4">
                        <small class="text-warning-emphasis">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>Atención:</strong> Esta operación puede demorar. Se generará un movimiento de deuda en la cuenta corriente de cada cliente.
                        </small>
                    </div>
                    
                    <form th:action="@{/facturas/generar-masiva}" method="post"
                          onsubmit="return confirm('¿CONFIRMAR PROCESO MASIVO?');">
                        
                        <!-- Tipo de Facturación -->
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Tipo de Facturación</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoFacturacion" 
                                       id="tipoMensualMas" value="mensual" checked 
                                       onchange="toggleRangoFechasMasiva()">
                                <label class="form-check-label small" for="tipoMensualMas">
                                    <strong>Por Mes</strong> (Seleccionar mes completo)
                                </label>
                                
                                <!-- Selector de Mes (visible solo si es mensual) -->
                                <div id="selectorMesContainerMas" class="mt-2 ms-3" style="max-width: 200px;">
                                    <label for="mesFacturacionMas" class="form-label small text-muted" style="font-size: 0.75rem;">Mes a facturar:</label>
                                    <input type="month" id="mesFacturacionMas" name="mesFacturacion" class="form-control form-control-sm">
                                    <div class="form-text" style="font-size: 0.7rem;">Si se deja vacío, se usará el mes anterior.</div>
                                </div>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="radio" name="tipoFacturacion" 
                                       id="tipoRangoMas" value="rango" 
                                       onchange="toggleRangoFechasMasiva()">
                                <label class="form-check-label small" for="tipoRangoMas">
                                    <strong>Rango personalizado</strong> (especificar fechas exactas)
                                </label>
                            </div>
                        </div>

                        <!-- Campos de Rango (inicialmente ocultos) -->
                        <div id="rangoFechasMasiva" style="display: none;" class="mb-3">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label for="fechaInicioMas" class="form-label fw-bold small">
                                        <i class="bi bi-calendar-range me-1"></i> Desde
                                    </label>
                                    <input type="date" name="fechaInicio" id="fechaInicioMas" class="form-control form-control-sm">
                                </div>
                                <div class="col-6">
                                    <label for="fechaFinMas" class="form-label fw-bold small">
                                        <i class="bi bi-calendar-range me-1"></i> Hasta
                                    </label>
                                    <input type="date" name="fechaFin" id="fechaFinMas" class="form-control form-control-sm">
                                </div>
                            </div>
                        </div>

                        <!-- Selección de Servicios (Filtro) -->
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Filtrar por Servicios (Opcional)</label>
                            <div class="card p-2 bg-light">
                                <div class="form-check mb-2 border-bottom pb-2">
                                    <input class="form-check-input" type="checkbox" id="selectAllServiciosMas" checked onchange="toggleAllServiciosMas()">
                                    <label class="form-check-label fw-bold small" for="selectAllServiciosMas">Seleccionar Todos</label>
                                </div>
                                <div style="max-height: 150px; overflow-y: auto;">
                                    <div th:each="s : ${listaServicios}" class="form-check">
                                        <input class="form-check-input servicio-checkbox-mas" type="checkbox" 
                                               name="serviciosIds" th:value="${s.id}" th:id="'serv_mas_' + ${s.id}" checked>
                                        <label class="form-check-label small" th:for="'serv_mas_' + ${s.id}" 
                                               th:text="${s.nombre + ' - $' + s.precio}">
                                        </label>
                                    </div>
                                </div>
                                <div class="form-text" style="font-size: 0.7rem;">Se facturarán solo los servicios seleccionados a los clientes que los tengan activos.</div>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-purple">
                                <i class="bi bi-lightning-charge-fill me-2"></i> EJECUTAR PROCESO MASIVO
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Toggle para facturación individual
        function toggleRangoFechasIndividual() {
            const tipoRango = document.getElementById('tipoRangoInd').checked;
            const rangoDiv = document.getElementById('rangoFechasIndividual');
            const mesContainer = document.getElementById('selectorMesContainer');
            
            if (tipoRango) {
                rangoDiv.style.display = 'block';
                if(mesContainer) mesContainer.style.display = 'none';
                
                // Hacer obligatorios los campos de rango
                document.getElementById('fechaInicioInd').required = true;
                document.getElementById('fechaFinInd').required = true;
                
                // Establecer fecha actual en los campos
                const hoy = new Date();
                const year = hoy.getFullYear();
                const month = String(hoy.getMonth() + 1).padStart(2, '0');
                const day = String(hoy.getDate()).padStart(2, '0');
                const fechaActual = `${year}-${month}-${day}`;
                
                document.getElementById('fechaEmisionInd').value = fechaActual;
                
                // Establecer primer día del mes anterior como inicio
                const mesAnterior = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
                const yearAnt = mesAnterior.getFullYear();
                const monthAnt = String(mesAnterior.getMonth() + 1).padStart(2, '0');
                document.getElementById('fechaInicioInd').value = `${yearAnt}-${monthAnt}-01`;
                
                // Establecer último día del mes anterior como fin
                const ultimoDia = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
                const dayUlt = String(ultimoDia.getDate()).padStart(2, '0');
                document.getElementById('fechaFinInd').value = `${yearAnt}-${monthAnt}-${dayUlt}`;
            } else {
                rangoDiv.style.display = 'none';
                if(mesContainer) mesContainer.style.display = 'block';
                
                document.getElementById('fechaInicioInd').required = false;
                document.getElementById('fechaFinInd').required = false;
                
                // Pre-seleccionar mes anterior si está vacío
                const mesInput = document.getElementById('mesFacturacion');
                if (mesInput && !mesInput.value) {
                    const hoy = new Date();
                    const mesAnterior = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
                    const yearAnt = mesAnterior.getFullYear();
                    const monthAnt = String(mesAnterior.getMonth() + 1).padStart(2, '0');
                    mesInput.value = `${yearAnt}-${monthAnt}`;
                }
            }
        }

        // Inicializar al cargar
        document.addEventListener('DOMContentLoaded', function() {
            toggleRangoFechasIndividual();
            toggleRangoFechasMasiva();
        });

        // Toggle para facturación masiva
        function toggleRangoFechasMasiva() {
            const tipoRango = document.getElementById('tipoRangoMas').checked;
            const rangoDiv = document.getElementById('rangoFechasMasiva');
            const mesContainer = document.getElementById('selectorMesContainerMas');
            
            if (tipoRango) {
                rangoDiv.style.display = 'block';
                if(mesContainer) mesContainer.style.display = 'none';
                
                document.getElementById('fechaInicioMas').required = true;
                document.getElementById('fechaFinMas').required = true;
                
                // Establecer fechas por defecto si están vacías
                if(!document.getElementById('fechaInicioMas').value) {
                    const hoy = new Date();
                    const mesAnterior = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
                    const yearAnt = mesAnterior.getFullYear();
                    const monthAnt = String(mesAnterior.getMonth() + 1).padStart(2, '0');
                    document.getElementById('fechaInicioMas').value = `${yearAnt}-${monthAnt}-01`;
                    
                    const ultimoDia = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
                    const dayUlt = String(ultimoDia.getDate()).padStart(2, '0');
                    document.getElementById('fechaFinMas').value = `${yearAnt}-${monthAnt}-${dayUlt}`;
                }
            } else {
                rangoDiv.style.display = 'none';
                if(mesContainer) mesContainer.style.display = 'block';
                
                document.getElementById('fechaInicioMas').required = false;
                document.getElementById('fechaFinMas').required = false;
                
                // Pre-seleccionar mes anterior si está vacío
                const mesInput = document.getElementById('mesFacturacionMas');
                if (mesInput && !mesInput.value) {
                    const hoy = new Date();
                    const mesAnterior = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
                    const yearAnt = mesAnterior.getFullYear();
                    const monthAnt = String(mesAnterior.getMonth() + 1).padStart(2, '0');
                    mesInput.value = `${yearAnt}-${monthAnt}`;
                }
            }
        }

        function toggleAllServiciosMas() {
            const isChecked = document.getElementById('selectAllServiciosMas').checked;
            const checkboxes = document.querySelectorAll('.servicio-checkbox-mas');
            checkboxes.forEach(cb => cb.checked = isChecked);
        }

        // ==================== LÓGICA DE SERVICIOS POR CLIENTE ====================
        function cargarServiciosCliente() {
            const clienteId = document.getElementById('clienteId').value;
            const container = document.getElementById('serviciosContainer');
            const lista = document.getElementById('listaServicios');
            const mensaje = document.getElementById('mensajeSinServicios');
            
            if (!clienteId) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            lista.innerHTML = '<div class="text-center text-muted"><small>Cargando servicios...</small></div>';
            mensaje.style.display = 'none';
            
            fetch(`/facturas/api/servicios-cliente/${clienteId}`)
                .then(response => response.json())
                .then(data => {
                    lista.innerHTML = '';
                    if (data.length === 0) {
                        mensaje.style.display = 'block';
                        document.getElementById('selectAllServicios').disabled = true;
                    } else {
                        mensaje.style.display = 'none';
                        document.getElementById('selectAllServicios').disabled = false;
                        document.getElementById('selectAllServicios').checked = true;
                        
                        data.forEach(servicio => {
                            const div = document.createElement('div');
                            div.className = 'form-check';
                            div.innerHTML = `
                                <input class="form-check-input servicio-checkbox" type="checkbox" 
                                       name="serviciosIds" value="${servicio.id}" id="serv_${servicio.id}" checked>
                                <label class="form-check-label small" for="serv_${servicio.id}">
                                    ${servicio.nombre} - $${servicio.precio}
                                </label>
                            `;
                            lista.appendChild(div);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    lista.innerHTML = '<div class="text-danger small">Error al cargar servicios</div>';
                });
        }

        function toggleAllServicios() {
            const isChecked = document.getElementById('selectAllServicios').checked;
            const checkboxes = document.querySelectorAll('.servicio-checkbox');
            checkboxes.forEach(cb => cb.checked = isChecked);
        }
    </script>

</th:block>
</body>
</html>