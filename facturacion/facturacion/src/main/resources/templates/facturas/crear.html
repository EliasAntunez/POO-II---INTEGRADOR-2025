<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layouts/base :: layout(title=~{::title}, content=~{::content})}">
<head>
    <title>Generar Facturación</title>
</head>
<body>
<th:block th:fragment="content">

    <div class="d-flex align-items-center mb-4">
        <a th:href="@{/facturas/listar}" class="btn btn-outline-secondary me-3">
            <i class="bi bi-arrow-left"></i>
        </a>
        <h1 class="h2 mb-0">Panel de Generación de Facturas</h1>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
        <i class="bi bi-exclamation-octagon-fill me-2"></i> <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="row g-4">
        
        <div class="col-md-6">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                    <div class="d-flex align-items-center mb-1">
                        <div class="bg-primary bg-opacity-10 text-primary rounded p-3 me-3">
                            <i class="bi bi-person-badge fs-3"></i>
                        </div>
                        <div>
                            <h4 class="card-title mb-0">Facturación Individual</h4>
                            <small class="text-muted">Ciclo manual para un cliente</small>
                        </div>
                    </div>
                </div>
                <div class="card-body px-4">
                    <p class="card-text text-muted">
                        Utilice esta opción para generar la factura mensual de un cliente específico fuera del ciclo automático. 
                        El sistema buscará los <strong>servicios activos</strong> contratados por el cliente y generará la factura correspondiente.
                    </p>
                    
                    <hr>

                    <form th:action="@{/facturas/generar-individual}" method="post">
                        <div class="mb-3">
                            <label for="clienteId" class="form-label fw-bold">Seleccionar Cliente</label>
                            <select name="clienteId" id="clienteId" class="form-select" required onchange="cargarServiciosCliente()">
                                <option value="" disabled selected>-- Buscar cliente --</option>
                                <option th:each="c : ${clientes}" 
                                        th:value="${c.id}" 
                                        th:text="${c.razonSocial + ' (CUIT: ' + c.cuit + ')'}">
                                </option>
                            </select>
                        </div>

                        <!-- Selección de Servicios -->
                        <div id="serviciosContainer" class="mb-3" style="display: none;">
                            <label class="form-label fw-bold">Servicios a Facturar</label>
                            <div class="card p-3 bg-light">
                                <div class="form-check mb-2 border-bottom pb-2">
                                    <input class="form-check-input" type="checkbox" id="selectAllServicios" checked onchange="toggleAllServicios()">
                                    <label class="form-check-label fw-bold" for="selectAllServicios">Seleccionar Todos</label>
                                </div>
                                <div id="listaServicios" style="max-height: 200px; overflow-y: auto;">
                                    <!-- Checkboxes inyectados por JS -->
                                    <div class="text-center text-muted"><small>Cargando servicios...</small></div>
                                </div>
                                <div id="mensajeSinServicios" class="text-danger small mt-2" style="display:none;">
                                    <i class="bi bi-exclamation-circle"></i> El cliente no tiene servicios activos.
                                </div>
                            </div>
                            <div class="form-text small">Si no selecciona ninguno, no se generará factura.</div>
                        </div>
                        
                        <!-- Tipo de Facturación -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tipo de Facturación</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoFacturacion" 
                                       id="tipoMensualInd" value="mensual" checked 
                                       onchange="toggleRangoFechasIndividual()">
                                <label class="form-check-label" for="tipoMensualInd">
                                    <strong>Por Mes</strong> (Seleccionar mes completo)
                                </label>
                                
                                <!-- Selector de Mes (visible solo si es mensual) -->
                                <div id="selectorMesContainer" class="mt-2 ms-3" style="max-width: 200px;">
                                    <label for="mesFacturacion" class="form-label small text-muted">Mes a facturar:</label>
                                    <input type="month" id="mesFacturacion" name="mesFacturacion" class="form-control form-control-sm">
                                    <div class="form-text small">Si se deja vacío, se usará el mes anterior.</div>
                                </div>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="radio" name="tipoFacturacion" 
                                       id="tipoRangoInd" value="rango" 
                                       onchange="toggleRangoFechasIndividual()">
                                <label class="form-check-label" for="tipoRangoInd">
                                    <strong>Rango personalizado</strong> (especificar fechas exactas)
                                </label>
                            </div>
                        </div>
                        
                        <!-- Campos de Rango (inicialmente ocultos) -->
                        <div id="rangoFechasIndividual" style="display: none;">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="fechaEmisionInd" class="form-label fw-bold">
                                        <i class="bi bi-calendar-event me-1"></i> Fecha Emisión
                                    </label>
                                    <input type="date" name="fechaEmision" id="fechaEmisionInd" class="form-control">
                                    <small class="text-muted">Hoy si se deja vacío</small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="fechaInicioInd" class="form-label fw-bold">
                                        <i class="bi bi-calendar-range me-1"></i> Desde
                                    </label>
                                    <input type="date" name="fechaInicio" id="fechaInicioInd" class="form-control">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="fechaFinInd" class="form-label fw-bold">
                                        <i class="bi bi-calendar-range me-1"></i> Hasta
                                    </label>
                                    <input type="date" name="fechaFin" id="fechaFinInd" class="form-control">
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-receipt me-1"></i> Generar Factura Individual
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                    <div class="d-flex align-items-center mb-1">
                        <div class="bg-success bg-opacity-10 text-success rounded p-3 me-3">
                            <i class="bi bi-collection-play fs-3"></i>
                        </div>
                        <div>
                            <h4 class="card-title mb-0">Facturación Masiva</h4>
                            <small class="text-muted">Ciclo mensual automático</small>
                        </div>
                    </div>
                </div>
                <div class="card-body px-4">
                    <p class="card-text text-muted">
                        Este proceso genera facturas para <strong>TODOS</strong> los clientes activos con servicios contratados.
                    </p>
                    
                    <div class="alert alert-info border-0 bg-info bg-opacity-10 mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Normativa AFIP:</strong>
                        <ul class="mb-0 mt-2 small">
                            <li>La fecha debe ser el <strong>último día del mes</strong> o hasta <strong>10 días antes</strong></li>
                            <li>No se puede facturar dos veces el mismo período</li>
                            <li>El período facturado es el mes correspondiente</li>
                        </ul>
                    </div>
                    
                    <div class="alert alert-warning border-0 bg-warning bg-opacity-10">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Atención:</strong> Esta operación puede demorar dependiendo de la cantidad de clientes.
                    </div>
                    
                    <hr>

                    <form th:action="@{/facturas/generar-masiva}" method="post" 
                          onsubmit="return confirm('¿Está seguro de ejecutar la FACTURACIÓN MASIVA? Se generarán facturas para todos los clientes activos.');">
                        
                        <!-- Tipo de Facturación -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tipo de Facturación</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoFacturacion" 
                                       id="tipoMensual" value="mensual" checked 
                                       onchange="toggleRangoFechasMasiva()">
                                <label class="form-check-label" for="tipoMensual">
                                    <strong>Mensual con AFIP</strong> (normativa estricta)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoFacturacion" 
                                       id="tipoRango" value="rango" 
                                       onchange="toggleRangoFechasMasiva()">
                                <label class="form-check-label" for="tipoRango">
                                    <strong>Rango personalizado</strong> (sin restricciones AFIP)
                                </label>
                            </div>
                        </div>
                        
                        <!-- Facturación Mensual (por defecto) -->
                        <div id="facturacionMensual">
                            <div class="mb-3">
                                <label for="fechaEmision" class="form-label fw-bold">
                                    <i class="bi bi-calendar-event me-1"></i> Fecha de Emisión
                                </label>
                                <input type="date" 
                                       name="fechaEmision" 
                                       id="fechaEmision" 
                                       class="form-control">
                                <small class="form-text text-muted">
                                    Debe ser el último día del mes o hasta 10 días antes. Hoy si se deja vacío.
                                </small>
                            </div>
                        </div>
                        
                        <!-- Facturación por Rango (inicialmente oculto) -->
                        <div id="facturacionRango" style="display: none;">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="fechaEmisionRango" class="form-label fw-bold">
                                        <i class="bi bi-calendar-event me-1"></i> Fecha Emisión
                                    </label>
                                    <input type="date" name="fechaEmision" id="fechaEmisionRango" class="form-control">
                                    <small class="text-muted">Hoy si se deja vacío</small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="fechaInicio" class="form-label fw-bold">
                                        <i class="bi bi-calendar-range me-1"></i> Período Desde
                                    </label>
                                    <input type="date" name="fechaInicio" id="fechaInicio" class="form-control">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="fechaFin" class="form-label fw-bold">
                                        <i class="bi bi-calendar-range me-1"></i> Período Hasta
                                    </label>
                                    <input type="date" name="fechaFin" id="fechaFin" class="form-control">
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-morado btn-lg">
                                <i class="bi bi-lightning-charge-fill me-2"></i> EJECUTAR PROCESO MASIVO
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>
<style>
.btn-morado {
    background-color: #8000ff !important; /* Morado fuerte */
    border-color: #8000ff !important;
    color: #fff !important;
}
.btn-morado:hover, .btn-morado:focus {
    background-color: #5a00b3 !important;
    border-color: #5a00b3 !important;
    color: #fff !important;
}
</style>

<script>
// Establecer fecha actual como valor por defecto y máximo
document.addEventListener('DOMContentLoaded', function() {
    const fechaInput = document.getElementById('fechaEmision');
    if (fechaInput) {
        const hoy = new Date();
        const year = hoy.getFullYear();
        const month = String(hoy.getMonth() + 1).padStart(2, '0');
        const day = String(hoy.getDate()).padStart(2, '0');
        const fechaActual = `${year}-${month}-${day}`;
        
        fechaInput.value = fechaActual;
        fechaInput.max = fechaActual;
    }
});

// Toggle para facturación individual
function toggleRangoFechasIndividual() {
    const tipoRango = document.getElementById('tipoRangoInd').checked;
    const rangoDiv = document.getElementById('rangoFechasIndividual');
    const mesContainer = document.getElementById('selectorMesContainer');
    
    if (tipoRango) {
        rangoDiv.style.display = 'block';
        if(mesContainer) mesContainer.style.display = 'none';
        
        // Hacer obligatorios los campos de rango
        document.getElementById('fechaInicioInd').required = true;
        document.getElementById('fechaFinInd').required = true;
        
        // Establecer fecha actual en los campos
        const hoy = new Date();
        const year = hoy.getFullYear();
        const month = String(hoy.getMonth() + 1).padStart(2, '0');
        const day = String(hoy.getDate()).padStart(2, '0');
        const fechaActual = `${year}-${month}-${day}`;
        
        document.getElementById('fechaEmisionInd').value = fechaActual;
        
        // Establecer primer día del mes anterior como inicio
        const mesAnterior = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
        const yearAnt = mesAnterior.getFullYear();
        const monthAnt = String(mesAnterior.getMonth() + 1).padStart(2, '0');
        document.getElementById('fechaInicioInd').value = `${yearAnt}-${monthAnt}-01`;
        
        // Establecer último día del mes anterior como fin
        const ultimoDia = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
        const dayUlt = String(ultimoDia.getDate()).padStart(2, '0');
        document.getElementById('fechaFinInd').value = `${yearAnt}-${monthAnt}-${dayUlt}`;
    } else {
        rangoDiv.style.display = 'none';
        if(mesContainer) mesContainer.style.display = 'block';
        
        document.getElementById('fechaInicioInd').required = false;
        document.getElementById('fechaFinInd').required = false;
        
        // Pre-seleccionar mes anterior si está vacío
        const mesInput = document.getElementById('mesFacturacion');
        if (mesInput && !mesInput.value) {
            const hoy = new Date();
            const mesAnterior = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
            const yearAnt = mesAnterior.getFullYear();
            const monthAnt = String(mesAnterior.getMonth() + 1).padStart(2, '0');
            mesInput.value = `${yearAnt}-${monthAnt}`;
        }
    }
}

// Inicializar al cargar
document.addEventListener('DOMContentLoaded', function() {
    toggleRangoFechasIndividual();
});

// Toggle para facturación masiva
function toggleRangoFechasMasiva() {
    const tipoMensual = document.getElementById('tipoMensual').checked;
    const mensualDiv = document.getElementById('facturacionMensual');
    const rangoDiv = document.getElementById('facturacionRango');
    
    if (tipoMensual) {
        mensualDiv.style.display = 'block';
        rangoDiv.style.display = 'none';
        // Limpiar valores de rango
        document.getElementById('fechaEmisionRango').value = '';
        document.getElementById('fechaInicio').value = '';
        document.getElementById('fechaFin').value = '';
    } else {
        mensualDiv.style.display = 'none';
        rangoDiv.style.display = 'block';
        
        // Establecer valores por defecto
        const hoy = new Date();
        const year = hoy.getFullYear();
        const month = String(hoy.getMonth() + 1).padStart(2, '0');
        const day = String(hoy.getDate()).padStart(2, '0');
        const fechaActual = `${year}-${month}-${day}`;
        
        document.getElementById('fechaEmisionRango').value = fechaActual;
        
        // Establecer primer día del mes anterior como inicio
        const mesAnterior = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
        const yearAnt = mesAnterior.getFullYear();
        const monthAnt = String(mesAnterior.getMonth() + 1).padStart(2, '0');
        document.getElementById('fechaInicio').value = `${yearAnt}-${monthAnt}-01`;
        
        // Establecer último día del mes anterior como fin
        const ultimoDia = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
        const dayUlt = String(ultimoDia.getDate()).padStart(2, '0');
        document.getElementById('fechaFin').value = `${yearAnt}-${monthAnt}-${dayUlt}`;
    }
}

// ==================== LÓGICA DE SERVICIOS POR CLIENTE ====================
function cargarServiciosCliente() {
    const clienteId = document.getElementById('clienteId').value;
    const container = document.getElementById('serviciosContainer');
    const lista = document.getElementById('listaServicios');
    const mensaje = document.getElementById('mensajeSinServicios');
    
    if (!clienteId) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    lista.innerHTML = '<div class="text-center text-muted"><small>Cargando servicios...</small></div>';
    mensaje.style.display = 'none';
    
    fetch(`/facturas/api/servicios-cliente/${clienteId}`)
        .then(response => response.json())
        .then(data => {
            lista.innerHTML = '';
            if (data.length === 0) {
                mensaje.style.display = 'block';
                document.getElementById('selectAllServicios').disabled = true;
            } else {
                mensaje.style.display = 'none';
                document.getElementById('selectAllServicios').disabled = false;
                document.getElementById('selectAllServicios').checked = true;
                
                data.forEach(servicio => {
                    const div = document.createElement('div');
                    div.className = 'form-check';
                    div.innerHTML = `
                        <input class="form-check-input servicio-checkbox" type="checkbox" 
                               name="serviciosIds" value="${servicio.id}" id="serv_${servicio.id}" checked>
                        <label class="form-check-label" for="serv_${servicio.id}">
                            ${servicio.nombre} - $${servicio.precio}
                        </label>
                    `;
                    lista.appendChild(div);
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            lista.innerHTML = '<div class="text-danger small">Error al cargar servicios</div>';
        });
}

function toggleAllServicios() {
    const isChecked = document.getElementById('selectAllServicios').checked;
    const checkboxes = document.querySelectorAll('.servicio-checkbox');
    checkboxes.forEach(cb => cb.checked = isChecked);
}
</script>

</th:block>
</body>
</html>